#!/usr/bin/env bash
# Summary: pause the cluster

csource="${BASH_SOURCE[0]}"
while [ -h "$csource" ] ; do csource="$(readlink "$csource")"; done
root="$( cd -P "$( dirname "$csource" )/" && pwd )" || exit 1

. "${root}/common.bash" || exit 1

for arg in "${@}"; do
    if [ "${arg}" == "-h" ] || [ "${arg}" == "--help" ]; then
        help="1"
    fi
done

if [ -n "${help}" ]; then
    printf "Usage: %s\n" "${SCRIPT_NAME}"
    exit 1
fi

cluster-must-exist

instance_list="$(get-instances)" || exit
readarray -t instances < <(printf "%s" "${instance_list}")

info "Pausing cluster..."

pids=()
for instance in "${instances[@]}"; do
    pause-instance "${instance}" &
    pids+=("${!}")
done

result=0
for pid in "${pids[@]}"; do
    if ! wait "${pid}"; then
        result=1
    fi
done

if [ "${result}" == "1" ]; then
    failure "Unexepcted error encountered pausing cluster"
fi

success "Cluster is paused"
